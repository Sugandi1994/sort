<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penghapus Latar Belakang (Background) Foto</title>
    <!-- Memuat Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gaya kustom untuk memastikan kanvas dan kontrol terlihat bagus */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        #canvas-container {
            position: relative;
            /* Ukuran container utama untuk kanvas, responsif di mobile */
            max-width: 90vw;
            max-height: 70vh;
            margin: auto;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Penting agar kuas tidak keluar batas */
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #drawing-canvas, #display-canvas {
            cursor: crosshair;
            display: block;
            background-color: transparent;
        }
        /* Style untuk kuas penghapus */
        #brush-preview {
            position: absolute;
            pointer-events: none; /* Agar tidak menghalangi interaksi kanvas */
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            background-color: rgba(255, 0, 0, 0.5); /* Warna overlay saat menghapus */
            display: none; /* Sembunyikan secara default */
            z-index: 10;
        }
        .control-group {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            Aplikasi Penghapus Latar Belakang Sederhana
        </h1>

        <!-- Area Kontrol Atas -->
        <div class="control-group mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <!-- Input File -->
            <label for="imageUpload" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Pilih Foto
                <input type="file" id="imageUpload" accept="image/*" class="hidden" />
            </label>

            <!-- Kontrol Kuas/Brush -->
            <div class="flex items-center space-x-4">
                <label for="brushSize" class="text-gray-700 font-medium whitespace-nowrap">Ukuran Kuas: <span id="brushSizeValue" class="font-bold text-indigo-600">50</span></label>
                <input type="range" id="brushSize" min="10" max="200" value="50" class="w-full md:w-40 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- Tombol Simpan -->
            <button id="saveButton" disabled class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md disabled:opacity-50 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Simpan PNG (Transparan)
            </button>
        </div>

        <!-- Kontainer Kanvas & Preview Kuas -->
        <div id="canvas-container" class="w-full h-96 bg-gray-200 border-dashed border-2 border-gray-400">
            <!-- Kanvas 1: Menampilkan Foto Asli & Hasil Masking (yang akan kita simpan) -->
            <canvas id="display-canvas" class="absolute top-0 left-0"></canvas>

            <!-- Kanvas 2: Untuk menggambar mask/area yang akan dihapus -->
            <canvas id="drawing-canvas" class="absolute top-0 left-0"></canvas>

            <!-- Preview Kuas -->
            <div id="brush-preview"></div>

            <p id="infoMessage" class="text-gray-500 text-lg p-4">
                Pilih foto untuk memulai!
            </p>
        </div>

        <!-- Area Pesan (untuk error/informasi) -->
        <div id="statusMessage" class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
    </div>

    <script>
        // Inisialisasi variabel global
        let image = null;
        let isDrawing = false;
        let brushSize = 50;
        let lastX = 0;
        let lastY = 0;
        let originalWidth = 0;
        let originalHeight = 0;

        // Mendapatkan elemen DOM
        const container = document.getElementById('canvas-container');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const displayCanvas = document.getElementById('display-canvas');
        const imageUpload = document.getElementById('imageUpload');
        const brushSizeInput = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const saveButton = document.getElementById('saveButton');
        const infoMessage = document.getElementById('infoMessage');
        const brushPreview = document.getElementById('brush-preview');
        const statusMessage = document.getElementById('statusMessage');

        // Mendapatkan konteks 2D untuk kanvas
        const drawingCtx = drawingCanvas.getContext('2d');
        const displayCtx = displayCanvas.getContext('2d');

        // --- FUNGSI UTILITY ---

        // Fungsi untuk menampilkan pesan status/error
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 p-3 rounded-lg ${isError ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}`;
            statusMessage.style.display = 'block';
        }

        // Fungsi untuk menyembunyikan pesan status
        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        // Fungsi yang dipanggil saat ukuran kanvas berubah (resize atau pemuatan gambar baru)
        function resizeCanvases() {
            if (!image) return;

            // Hitung rasio untuk menyesuaikan gambar ke container
            const containerW = container.clientWidth;
            const containerH = container.clientHeight;

            const ratioX = containerW / originalWidth;
            const ratioY = containerH / originalHeight;
            const ratio = Math.min(ratioX, ratioY);

            // Tentukan ukuran baru kanvas berdasarkan rasio yang paling kecil
            const newW = originalWidth * ratio;
            const newH = originalHeight * ratio;

            // Set ukuran fisik elemen kanvas
            drawingCanvas.style.width = displayCanvas.style.width = `${newW}px`;
            drawingCanvas.style.height = displayCanvas.style.height = `${newH}px`;

            // Set resolusi internal kanvas
            drawingCanvas.width = displayCanvas.width = newW;
            drawingCanvas.height = displayCanvas.height = newH;

            // Terapkan kembali gambar pada kanvas utama
            redrawDisplay();

            // Atur konteks gambar untuk kanvas masking
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            drawingCtx.globalCompositeOperation = 'destination-out'; // Mode penghapusan
        }

        // Fungsi untuk menggambar ulang kanvas tampilan utama
        function redrawDisplay() {
            if (!image) return;

            const w = displayCanvas.width;
            const h = displayCanvas.height;

            // 1. Gambar latar belakang kotak-kotak (transparansi)
            drawCheckerboard(displayCtx, w, h);

            // 2. Gambar foto asli
            displayCtx.drawImage(image, 0, 0, w, h);

            // 3. Terapkan masking dari drawingCanvas ke displayCanvas (memotong area yang dihapus)
            // Simpan kondisi kanvas saat ini
            displayCtx.save();

            // Set operasi komposit untuk menggunakan mask (hanya tampilkan area yang TIDAK di-mask)
            // source-atop: Gambar sumber (mask) diletakkan di atas tujuan, hanya di bagian yang sudah ada pikselnya.
            // Kita akan menggunakan drawingCanvas sebagai mask!
            displayCtx.globalCompositeOperation = 'destination-out';
            displayCtx.drawImage(drawingCanvas, 0, 0, w, h);

            // Kembalikan ke operasi komposit default
            displayCtx.restore();
        }

        // Fungsi untuk membuat latar belakang kotak-kotak transparan
        function drawCheckerboard(ctx, w, h) {
            const size = 15;
            const color1 = '#ccc';
            const color2 = '#ddd';

            ctx.clearRect(0, 0, w, h); // Hapus dulu

            for (let y = 0; y < h; y += size) {
                for (let x = 0; x < w; x += size) {
                    ctx.fillStyle = ((x / size) % 2 === (y / size) % 2) ? color1 : color2;
                    ctx.fillRect(x, y, size, size);
                }
            }
        }

        // --- EVENT HANDLERS ---

        // Pemuatan Gambar
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            hideStatus();
            infoMessage.style.display = 'none';
            saveButton.disabled = true;

            const reader = new FileReader();
            reader.onload = (event) => {
                image = new Image();
                image.onload = () => {
                    originalWidth = image.width;
                    originalHeight = image.height;

                    // Bersihkan kanvas masking (mask awal harus kosong/putih)
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    
                    resizeCanvases();
                    saveButton.disabled = false;
                    showStatus('Foto siap diedit. Gunakan kuas untuk menghapus latar belakang.', false);
                };
                image.onerror = () => {
                    showStatus('Gagal memuat gambar. Pastikan file adalah format gambar yang valid.', true);
                    image = null;
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Update Ukuran Kuas
        brushSizeInput.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value, 10);
            brushSizeValue.textContent = brushSize;
            brushPreview.style.width = brushPreview.style.height = `${brushSize}px`;
        });

        // --- LOGIKA MOUSE/TOUCH (MENGGAMBAR) ---

        // Fungsi untuk mendapatkan koordinat relatif
        function getCanvasCoords(event) {
            const rect = drawingCanvas.getBoundingClientRect();
            let clientX, clientY;

            if (event.touches && event.touches.length > 0) {
                // Untuk peristiwa sentuhan (touch event)
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                // Untuk peristiwa mouse
                clientX = event.clientX;
                clientY = event.clientY;
            }

            const x = clientX - rect.left;
            const y = clientY - rect.top;

            return { x, y };
        }

        // Mulai Menggambar
        function startDrawing(e) {
            e.preventDefault();
            if (!image) return;

            isDrawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;

            // Gambar titik awal
            draw(lastX, lastY);
        }

        // Menggambar
        function draw(x, y) {
            // Skala ukuran kuas berdasarkan resolusi kanvas vs ukuran elemen
            const scaleX = drawingCanvas.width / drawingCanvas.clientWidth;
            const scaleY = drawingCanvas.height / drawingCanvas.clientHeight;

            drawingCtx.lineWidth = brushSize * scaleX; // Sesuaikan lebar kuas

            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX * scaleX, lastY * scaleY);
            drawingCtx.lineTo(x * scaleX, y * scaleY);
            drawingCtx.strokeStyle = 'red'; // Warna ini tidak terlihat karena destination-out
            drawingCtx.stroke();

            lastX = x;
            lastY = y;

            // Setelah menggambar mask, perbarui tampilan utama
            redrawDisplay();
        }

        // Selama Menggambar/Mouse Bergerak
        function whileDrawing(e) {
            e.preventDefault();
            const coords = getCanvasCoords(e);

            // Perbarui preview kuas
            brushPreview.style.left = `${coords.x - (brushSize / 2)}px`;
            brushPreview.style.top = `${coords.y - (brushSize / 2)}px`;

            if (!isDrawing) return;

            draw(coords.x, coords.y);
        }

        // Akhiri Menggambar
        function stopDrawing() {
            isDrawing = false;
        }

        // Mouse Enter/Leave (Tampilkan/Sembunyikan Kuas Preview)
        container.addEventListener('mouseenter', () => {
            if (image) {
                brushPreview.style.display = 'block';
                brushPreview.style.width = brushPreview.style.height = `${brushSize}px`;
            }
        });
        container.addEventListener('mouseleave', () => {
            brushPreview.style.display = 'none';
            stopDrawing(); // Pastikan berhenti menggambar jika keluar
        });

        // Event listener untuk Mouse
        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', whileDrawing);
        drawingCanvas.addEventListener('mouseup', stopDrawing);

        // Event listener untuk Touch
        drawingCanvas.addEventListener('touchstart', startDrawing);
        drawingCanvas.addEventListener('touchmove', whileDrawing);
        drawingCanvas.addEventListener('touchend', stopDrawing);

        // --- SIMPAN FILE PNG ---

        saveButton.addEventListener('click', () => {
            if (!image) {
                showStatus('Tidak ada gambar yang dimuat untuk disimpan.', true);
                return;
            }

            // 1. Buat kanvas resolusi penuh untuk menyimpan hasil
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = originalWidth;
            finalCanvas.height = originalHeight;
            const finalCtx = finalCanvas.getContext('2d');

            // 2. Gambar foto asli ke kanvas final
            finalCtx.drawImage(image, 0, 0, originalWidth, originalHeight);

            // 3. Terapkan mask dari drawingCanvas ke kanvas final
            // Skala drawingCanvas ke resolusi originalWidth/originalHeight
            const tempMaskCanvas = document.createElement('canvas');
            tempMaskCanvas.width = originalWidth;
            tempMaskCanvas.height = originalHeight;
            const tempMaskCtx = tempMaskCanvas.getContext('2d');
            
            // Atur mask kanvas agar sesuai dengan apa yang digambar di drawingCanvas (yang skalanya lebih kecil)
            tempMaskCtx.drawImage(drawingCanvas, 0, 0, tempMaskCanvas.width, tempMaskCanvas.height);

            // Terapkan mask ke gambar asli
            finalCtx.globalCompositeOperation = 'destination-out';
            finalCtx.drawImage(tempMaskCanvas, 0, 0);

            // 4. Unduh file
            const dataURL = finalCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'foto-tanpa-background.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showStatus('Gambar berhasil disimpan sebagai PNG transparan!', false);
        });


        // --- SETUP AWAL ---

        // Pastikan kanvas menyesuaikan ukuran saat jendela diubah
        window.addEventListener('resize', resizeCanvases);

        // Set ukuran awal kuas preview
        brushPreview.style.width = brushPreview.style.height = `${brushSize}px`;

    </script>
</body>
</html>
